

**Проект:** интернет‑магазин (микросервисная архитектура на Golang + gRPC + HTTP) **Версия:** 23 апреля 2025 г.

---

## 1. Введение

Цель — построить масштабируемую, устойчивую и безопасную платформу интернет‑торговли. В новой версии ТЗ учтены замечания к первоначальной архитектуре:

- устранены тесные связи между сервисами;
    
- добавлены механизмы Outbox/Inbox, Saga‑паттерны и историзация данных;
    
- заменена синхронная REST‑коммуникация на gRPC между сервисами;
    
- клиентский трафик остаётся HTTP (Swagger/OpenAPI);
    
- убрано дублирование конфиденциальных данных и хранение номеров карт.
    

---

## 2. Технологический стек

|Слой|Выбор|
|---|---|
|Язык сервисов|**Golang ≥ 1.22**|
|Внутренняя связь|**gRPC (Protocol Buffers v3) + mTLS**|
|Внешний API|**HTTP 1.1 / JSON** через API‑шлюз, OpenAPI 3.1|
|Event‑bus|**Apache Kafka 3.x** (3 брокера, ISR ≥ 2) + Confluent Schema Registry (Protobuf)|
|БД|**PostgreSQL 15**, PK — UUID v7 (ulid)|
|Кэш / RT‑хранилище|**Redis Cluster 7** (Sentinel)|
|Observability|**OpenTelemetry → Jaeger + Prometheus/Grafana + Loki**|
|Gateway|**Envoy Proxy** (xDS), rate‑limit + auth‑filter|
|CI/CD|GitHub Actions → Argo CD (blue/green, canary)|
|Orchestration|Kubernetes 1.30|

---

## 3. Архитектурные компоненты

### 3.1 API Gateway (Envoy)

- TLS‑терминация, HTTP‑routing, rate‑limiting.
    
- gRPC‑JSON Transcoder для публичного REST‑API.
    
- mTLS к бэкенд‑сервисам.
    

### 3.2 Сервисы (Golang + gRPC)

#### Обзор

Ниже — краткое описание зоны ответственности **каждого** компонента (в стиле ранее использованного примера), прежде чем перейти к подробному описанию API и событий.

- **API Gateway (Envoy)**
    
    - Принимает все внешние HTTP/HTTPS‑запросы.
        
    - Терминирует TLS, делает rate‑limit и аутентификацию JWT.
        
    - Выполняет gRPC‑JSON транскодинг и маршрутизацию к сервисам.
        
- **Identity Service**
    
    - Аутентификация/авторизация пользователей, управление ролями.
        
    - Хранит логины и хэши паролей, refresh‑токены — в Redis (SHA‑256).
        
    - Выдаёт/проверяет JWT, публикует `user_registered`, `user_deactivated`.
        
- **Profile Service**
    
    - Управляет профилем (PII, email, имя), адресами доставки, токенами оплаты **и «списком желаемого» на уровне товаров** (по сути, набор избранных `product_id` без отдельной сущности wishlist).
        
    - Не хранит пароли и роли — только ссылку на `account_id` из Identity.
        
    - Реагирует на события Identity и транслирует изменения профиля.
        
- **Catalog Service****
    
    - Хранит товары, категории, цены; управление контентом каталога.
        
    - Публикует `product_created`, `product_updated`, `product_price_changed`.
        
    - Обеспечивает полнотекстовый поиск через Elastic read‑model.
        
- **Order Service**
    
    - Создание и хранение заказов; оркестрация бизнес‑саги (reserve → pay → confirm).
        
    - Сохраняет снимки адреса/оплаты для неизменности истории.
        
    - Публикует `order_draft_created`, `order_confirmed`, `order_cancelled`.
        
- **Inventory Service**
    
    - Учет остатков по складам, резервирование и списание товара.
        
    - Подписывается на `order_draft_created`, `product_created`; публикует `stock_reserved`.
        
- **Review Service**
    
    - CRUD отзывов, хранит оценки и комментарии.
        
    - Флагрует негативные отзывы, скрывает при `product_deleted`.
        
- **Payment Service**
    
    - Интегрируется с PSP (пример: Stripe, Adyen): авторизация, капчур, возвраты.
        
    - Не хранит PAN — только токены/идентификаторы платежа.
        
    - Webhook‑обработчик уведомлений PSP; публикует `payment_authorized`, `payment_captured`.
        

|Service|Responsibility|DB|Kafka topics|
|---|---|---|---|
|Identity|Аккаунты, аутентификация, роли, JWT/refresh|identity-db|`identity.events`|
|Profile|PII-данные, адреса, способы оплаты‑токены, wishlist‑items|profile-db|`profile.events`|
|Catalog|Товары, категории, ценообразование, поиск read-model|catalog-db|`product.events`|
|Order|Оформление заказа, оркестрация Saga, снимки адреса/оплаты|order-db|`order.events`|
|Inventory|Склады, остатки, резервы, партионный учёт|inventory-db|`inventory.events`|
|Review|Отзывы и рейтинги товаров|review-db|`review.events`|
|Payment|Интеграция с PSP, авторизация/капчур/возвраты|payment-db|`payment.events`|

---

#### 3.2.1 Identity Service

- **HTTP / grpc:**
    
    - `POST /auth/register` → `Register` — создание аккаунта.
        
    - `POST /auth/login` → `Login` — проверка логина/пароля, выдача JWT + refresh.
        
    - `POST /auth/refresh` → `RefreshToken` — ротация токенов.
        
    - `POST /auth/logout` → `RevokeRefresh` — добавление refresh‑токена в blacklist.
        
    - `GET /auth/keys` → `PublicKeys` — JWKS для проверки подписи.
        
- **gRPC методы:** `Register`, `Login`, `ValidateToken`, `RotateKeys`.
    
- **Kafka:**
    
    - Публикует: `user_registered`, `user_deactivated`, `jwt_key_rotated`.
        
    - Подписывается: нет.
        
- **Хранилище:** таблицы `accounts`, `roles`, `account_roles`, outbox/inbox.
    

#### 3.2.2 Profile Service

- **HTTP / grpc:** CRUD для профиля (`/profiles/me`), адресов (`/profiles/me/addresses`), платёжных токенов (`/payment‑tokens`).
    
- **Бизнес‑логика:**
    
    - Один источник истины для email, имени, PII.
        
    - Валидирует адреса через сторонний API (async `address_validated`).
        
- **Kafka:**
    
    - Публикует: `profile_created`, `profile_updated`.
        
    - Подписывается: `user_registered`, `user_deactivated` (от Identity) — создаёт/деактивирует профиль.
        

#### 3.2.3 Catalog Service

- **HTTP / grpc:** CRUD `products`, `categories`; bulk‑import; `GET /catalog/search?q=…` (проксируется к Elastic read‑model).
    
- **Особенности:** поддержка трансляции цен в разные валюты (Fx‑rates кешируются в Redis).
    
- **Kafka:**
    
    - Публикует: `product_created`, `product_updated`, `product_price_changed`.
        
    - Подписывается: ничего.
        

#### 3.2.4 Order Service

- **HTTP / grpc:**
    
    - `POST /orders` → `CreateDraft` (проверка JWT локально, без вызова Identity).
        
    - `GET /orders/{id}`
        
    - `POST /orders/{id}/cancel`.
        
- **Saga‑оркестратор:** шаги `reserve_stock` → `authorize_payment` → `capture_payment` → `confirm_order`; компенсации при сбое.
    
- **Kafka:**
    
    - Публикует: `order_draft_created`, `order_confirmed`, `order_cancelled`.
        
    - Подписывается: `stock_reserved/insufficient`, `payment_authorized/failed`.
        

#### 3.2.5 Inventory Service

- **HTTP / grpc (внутр.):** `ReserveStock`, `ReleaseStock`, `AddStock`, `TransferStock`.
    
- **Алгоритм резерва:** pessimistic‑lock на строку `inventory` + запись в `reservations` с TTL.
    
- **Kafka:**
    
    - Публикует: `stock_reserved`, `stock_released`, `stock_deducted`.
        
    - Подписывается: `order_draft_created` (резерв), `order_cancelled` (release), `product_created` (инициализация остатков).
        

#### 3.2.6 Review Service

- **HTTP / grpc:** `POST /products/{id}/reviews`, `GET /products/{id}/reviews`.
    
- **Moderation queue:** при рейтинге ≤ 2 публикует событие `review_flagged` для последующей ручной модерации.
    
- **Kafka:** принимает `product_deleted` — автоматически скрывает отзывы.
    

#### 3.2.7 Payment Service

- **HTTP (PSP Webhooks):** `/webhooks/psp` — приём callback‑ов.
    
- **gRPC внутреннее:** `Authorize`, `Capture`, `Refund`.
    
- **Процесс:**
    
    1. Получает `order_draft_created` → инициирует `Authorize` с PSP.
        
    2. По webhook `payment_authorized` публикует одноимённое событие.
        
- **Kafka:**
    
    - Публикует: `payment_authorized`, `payment_captured`, `payment_refunded`, `payment_failed`.
        
    - Подписывается: `order_confirmed` (capture), `order_cancelled` (refund/release).
        

---

### 3.3 Событийная шина (Kafka) Событийная шина (Kafka)

- Топики **по границам агрегатов**: `user.events`, `product.events`, `order.events`, …
    
- Схемы — Protobuf + versioning (backward + forward compatible).
    
- Outbox‑таблицы во всех сервисах, Debezium CDC → Kafka Connect.
    
- Потребители — Inbox‑паттерн с таблицей обработанных `event_id`.
    

### 3.4 Паттерн Saga

- **Order Saga (оркестратор)** в Order Service: Reserve Stock → Authorize Payment → Confirm Order | Compensations (Release Stock, Cancel Payment).
    

### 3.5 Безопасность

- mTLS между сервисами (SPIFFE / SPIRE).
    
- JWT (ES512); public‑key rotation публикуется событием `jwt_key_rotated`.
    
- Refresh‑токены — SHA‑256 хэш в Redis (+TTL).
    
- PCI DSS — только токены PSP, нет PAN/CSV.
    

---

## 4. Модель данных (изменения)

### 4.1 Общие принципы

- **UUID v7** в качестве PK/FK, `CHAR(36)`.
    
- Мягкое удаление — `deleted_at TIMESTAMPTZ NULL`, уникальные индексы c условием `WHERE deleted_at IS NULL`.
    
- Историзация — отдельные таблицы `_history` или JSONB‑снимки.
    

### 4.2 Order Service (пример)

```sql
CREATE TABLE orders (
    order_id          UUID PRIMARY KEY,
    profile_id        UUID NOT NULL,
    status            SMALLINT NOT NULL, -- enum в коде
    total_amount_cents BIGINT NOT NULL,
    currency          CHAR(3) NOT NULL,
    shipping_snapshot JSONB NOT NULL,
    payment_snapshot  JSONB NOT NULL,
    created_at        TIMESTAMPTZ NOT NULL DEFAULT now(),
    updated_at        TIMESTAMPTZ NOT NULL DEFAULT now()
);
```

### 4.3 Identity Service

- Таблица `accounts` без email/PII — только login, password_hash, role_ids.
    

### 4.4 Profile Service

- Email, имя, адреса — **единственный источник истины**.
    

### 4.5 Inventory

- `warehouses` + `inventory` (`warehouse_id, product_id` PK) + `reservations`.
    

Полные схемы / DDL в директории `/schema` (Alembic migrations).

---

## 5. Взаимодействие сервисов

### 5.1 Синхронно (gRPC)

- Лёгкие запросы «чтения» (get‑by‑id, health)
    
- Требуется deadline + retry‑policy на клиенте (`20 ms`, max `3` retries).
    

### 5.2 Асинхронно (Kafka)

- Доменные события, distrib. tracing через `trace_id` в header‑ах.
    
- Идемпотентность — Inbox‑таблица (`processed_event_id`).
    

### 5.3 Пример flow «Place Order»

1. Client → HTTP `POST /api/v1/orders` (JWT).
    
2. API Gateway → `OrderService.CreateDraft` (gRPC).
    
3. Order Saga публикует `order_draft_created` (outbox).
    
4. Inventory Service → резерв → событие `stock_reserved` или `stock_insufficient`.
    
5. Payment Service → PSP → `payment_authorized/failed`.
    
6. Оркестратор → финализирует заказ или выполняет компесации.
    

---

## 6. Observability

- **Tracing**: OpenTelemetry SDK для Go, экспортер OTLP/HTTP.
    
- **Metrics**: Prometheus → Grafana dashboards (`99‑th latency`, `error_rate`).
    
- **Logs**: zap → Loki (JSON).
    

---

## 7. Развёртывание и DevOps

- Docker‑образы (scratch + distroless).
    
- **Helm charts** (один chart ≈ один сервис).
    
- **Argo CD** — GitOps; PR → staging → auto‑tests → canary 10 % → full.
    
- **DB migrations** — отличные версии образов, запускаются Job‑ом до deploy.
    

---

## 8. Нефункциональные требования

- **SLA:** 99.9 % / 30 дней.
    
- **Латентность:** p95 < 120 ms (запрос каталога), < 250 ms (checkout).
    
- **РТО / RPO:** 15 мин / 5 мин.
    
- **GDPR / PCI DSS SAQ‑A.**
    

---

## 9. Каталог репозитория

```
├── api-gateway/         # envoy configs
├── services/
│   ├── identity/
│   ├── profile/
│   ├── catalog/
│   ├── order/
│   ├── inventory/
│   ├── review/
│   └── payment/
├── proto/               # *.proto, buf.gen.yaml
├── schema/              # DDL + migrations
├── devops/              # helm, kustomize
└── docs/                # ADR, diagrams
```

---

## 10. Полные схемы баз данных

> Все таблицы приведены в едином формате: `column | type | constraints | description`. Значения `PK`, `FK` и `UNIQUE` подразумевают соответствующие индексы. Во всех таблицах отсутствующие `deleted_at` поля означают, что запись физически удаляется.

### 10.0 Служебные таблицы (паттерн Outbox/Inbox)

|column|type|constraints|description|
|---|---|---|---|
|event_id|UUID|PK, NOT NULL|Идентификатор события|
|aggregate_type|VARCHAR(50)|NOT NULL|Тип агрегата‑источника|
|aggregate_id|UUID|NOT NULL|ID агрегата‑источника|
|payload|JSONB|NOT NULL|Protobuf‑payload|
|created_at|TIMESTAMPTZ|DEFAULT now()||

#### inbox

|column|type|constraints|description|
|---|---|---|---|
|event_id|UUID|PK, NOT NULL|Idempotency‑ключ|
|received_at|TIMESTAMPTZ|DEFAULT now()||
|processed_at|TIMESTAMPTZ|NULL|Заполняется после успешной обработки|

---

### 10.1 Identity DB

#### accounts

|column|type|constraints|description|
|---|---|---|---|
|account_id|UUID|PK, NOT NULL||
|login|VARCHAR(60)|UNIQUE, NOT NULL|Имя пользователя|
|password_hash|VARCHAR(255)|NOT NULL|bcrypt/argon2id|
|is_active|BOOLEAN|DEFAULT TRUE|Soft‑delete флаг|
|created_at|TIMESTAMPTZ|DEFAULT now()||
|updated_at|TIMESTAMPTZ|DEFAULT now()||

#### roles

|column|type|constraints|description|
|---|---|---|---|
|role_id|UUID|PK, NOT NULL||
|code|VARCHAR(40)|UNIQUE, NOT NULL|"ADMIN", "USER" …|
|description|VARCHAR(255)|NULL||
|created_at|TIMESTAMPTZ|DEFAULT now()||

#### account_roles

|column|type|constraints|description|
|---|---|---|---|
|account_id|UUID|PK, FK→accounts.account_id||
|role_id|UUID|PK, FK→roles.role_id||
|assigned_at|TIMESTAMPTZ|DEFAULT now()||

_(+ outbox, inbox)_

---

### 10.2 Profile DB

#### profiles

|column|type|constraints|description|
|---|---|---|---|
|profile_id|UUID|PK, NOT NULL||
|account_id|UUID|UNIQUE, FK→identity.accounts||
|email|VARCHAR(120)|UNIQUE, NOT NULL||
|first_name|VARCHAR(60)|NULL||
|last_name|VARCHAR(60)|NULL||
|deleted_at|TIMESTAMPTZ|NULL|Soft‑delete|
|created_at|TIMESTAMPTZ|DEFAULT now()||
|updated_at|TIMESTAMPTZ|DEFAULT now()||

#### shipping_addresses

|column|type|constraints|description|
|---|---|---|---|
|address_id|UUID|PK, NOT NULL||
|profile_id|UUID|FK→profiles.profile_id, NOT NULL||
|country|VARCHAR(100)|NOT NULL||
|city|VARCHAR(100)|NOT NULL||
|line1|VARCHAR(255)|NOT NULL||
|line2|VARCHAR(255)|NULL||
|postal_code|VARCHAR(20)|NOT NULL||
|deleted_at|TIMESTAMPTZ|NULL||
|created_at|TIMESTAMPTZ|DEFAULT now()||

#### payment_tokens

|column|type|constraints|description|
|---|---|---|---|
|token_id|UUID|PK, NOT NULL||
|profile_id|UUID|FK→profiles.profile_id, NOT NULL||
|psp_token|VARCHAR(255)|NOT NULL|Токен от PSP|
|brand|VARCHAR(30)|NOT NULL|"VISA", "MC" …|
|last4|CHAR(4)|NOT NULL||
|exp_month|SMALLINT|NOT NULL||
|exp_year|SMALLINT|NOT NULL||
|created_at|TIMESTAMPTZ|DEFAULT now()||

#### wishlist_items

|column|type|constraints|description|
|---|---|---|---|
|profile_id|UUID|PK, FK→profiles.profile_id, NOT NULL||
|product_id|UUID|PK, NOT NULL||
|added_at|TIMESTAMPTZ|DEFAULT now()||

_(+ outbox, inbox)_

---

### 10.3 Catalog DB Catalog DB

#### products

|column|type|constraints|description|
|---|---|---|---|
|product_id|UUID|PK, NOT NULL||
|name|VARCHAR(120)|UNIQUE, NOT NULL||
|description|TEXT|NULL||
|price_cents|BIGINT|NOT NULL||
|currency|CHAR(3)|NOT NULL|ISO‑4217|
|is_active|BOOLEAN|DEFAULT TRUE||
|created_at|TIMESTAMPTZ|DEFAULT now()||
|updated_at|TIMESTAMPTZ|DEFAULT now()||

#### product_images

|column|type|constraints|description|
|---|---|---|---|
|image_id|UUID|PK, NOT NULL||
|product_id|UUID|FK→products.product_id, NOT NULL||
|url|VARCHAR(255)|NOT NULL||
|alt|VARCHAR(255)|NULL||
|created_at|TIMESTAMPTZ|DEFAULT now()||

#### categories

|column|type|constraints|description|
|---|---|---|---|
|category_id|UUID|PK, NOT NULL||
|name|VARCHAR(100)|UNIQUE, NOT NULL||
|parent_id|UUID|FK→categories.category_id, NULL||
|created_at|TIMESTAMPTZ|DEFAULT now()||
|updated_at|TIMESTAMPTZ|DEFAULT now()||

#### product_categories

|column|type|constraints|description|
|---|---|---|---|
|product_id|UUID|PK, FK→products.product_id||
|category_id|UUID|PK, FK→categories.category_id||
|assigned_at|TIMESTAMPTZ|DEFAULT now()||

_(+ outbox, inbox)_

---

### 10.4 Order DB

#### orders

|column|type|constraints|description|
|---|---|---|---|
|order_id|UUID|PK, NOT NULL||
|profile_id|UUID|FK→profiles.profile_id, NOT NULL||
|status|SMALLINT|NOT NULL|Enum|
|total_amount_cents|BIGINT|NOT NULL||
|currency|CHAR(3)|NOT NULL||
|shipping_snapshot|JSONB|NOT NULL|Без ссылок|
|payment_snapshot|JSONB|NOT NULL||
|created_at|TIMESTAMPTZ|DEFAULT now()||
|updated_at|TIMESTAMPTZ|DEFAULT now()||

#### order_items

|column|type|constraints|description|
|---|---|---|---|
|order_item_id|UUID|PK, NOT NULL||
|order_id|UUID|FK→orders.order_id, NOT NULL||
|product_id|UUID|NOT NULL||
|quantity|INT|NOT NULL||
|unit_price_cents|BIGINT|NOT NULL|Цена на момент заказа|
|currency|CHAR(3)|NOT NULL||

#### saga_state

|column|type|constraints|description|
|---|---|---|---|
|saga_id|UUID|PK, NOT NULL||
|order_id|UUID|FK→orders.order_id, NOT NULL||
|step|SMALLINT|NOT NULL|Текущий шаг|
|data|JSONB|NULL|Расширенные данные|
|updated_at|TIMESTAMPTZ|DEFAULT now()||

_(+ outbox, inbox)_

---

### 10.5 Inventory DB

#### warehouses

|column|type|constraints|description|
|---|---|---|---|
|warehouse_id|UUID|PK, NOT NULL||
|name|VARCHAR(120)|NOT NULL||
|location|VARCHAR(255)|NULL||
|created_at|TIMESTAMPTZ|DEFAULT now()||

#### inventory

|column|type|constraints|description|
|---|---|---|---|
|warehouse_id|UUID|PK, FK→warehouses.warehouse_id||
|product_id|UUID|PK, NOT NULL||
|quantity|INT|NOT NULL|Current on‑hand|
|updated_at|TIMESTAMPTZ|DEFAULT now()||

#### reservations

|column|type|constraints|description|
|---|---|---|---|
|reservation_id|UUID|PK, NOT NULL||
|order_id|UUID|FK→orders.order_id, NOT NULL||
|warehouse_id|UUID|FK→warehouses.warehouse_id, NOT NULL||
|product_id|UUID|NOT NULL||
|reserved_qty|INT|NOT NULL||
|expires_at|TIMESTAMPTZ|NOT NULL||
|created_at|TIMESTAMPTZ|DEFAULT now()||

#### inventory_logs

|column|type|constraints|description|
|---|---|---|---|
|log_id|UUID|PK, NOT NULL||
|product_id|UUID|NOT NULL||
|change|INT|NOT NULL|Δ количества|
|reason|VARCHAR(60)|NOT NULL|"SALE", "RESTOCK" …|
|occurred_at|TIMESTAMPTZ|DEFAULT now()||

_(+ outbox, inbox)_

---

### 10.6 Payment DB

#### payments

|column|type|constraints|description|
|---|---|---|---|
|payment_id|UUID|PK, NOT NULL||
|order_id|UUID|UNIQUE, FK→orders.order_id|Связанный заказ|
|psp_reference|VARCHAR(100)|UNIQUE, NOT NULL|ID транзакции в PSP|
|amount_cents|BIGINT|NOT NULL|Сумма в центах|
|currency|CHAR(3)|NOT NULL|ISO‑4217|
|status|SMALLINT|NOT NULL|Enum (pending, authorized, captured, failed)|
|created_at|TIMESTAMPTZ|DEFAULT now()||
|updated_at|TIMESTAMPTZ|DEFAULT now()||

#### refunds

|column|type|constraints|description|
|---|---|---|---|
|refund_id|UUID|PK, NOT NULL||
|payment_id|UUID|FK→payments.payment_id, NOT NULL||
|amount_cents|BIGINT|NOT NULL||
|currency|CHAR(3)|NOT NULL||
|psp_reference|VARCHAR(100)|UNIQUE, NOT NULL|ID операции возврата в PSP|
|status|SMALLINT|NOT NULL|Enum (requested, processed, failed)|
|created_at|TIMESTAMPTZ|DEFAULT now()||
|updated_at|TIMESTAMPTZ|DEFAULT now()||

_(+ outbox, inbox)_

---

## 11. Диаграммы

- C4‑Model: `docs/diagrams/system‑context.drawio`.
    
- Sequence «Place Order»: `docs/diagrams/place_order.plantuml`.
    

---

**Конец ТЗ v2**