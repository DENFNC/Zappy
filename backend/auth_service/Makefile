APP_PROTO=proto/grpc/v1
APP_PROTO_GEN=proto/gen/v1
APP_PROTO_VALIDATE=proto/third_party
GOPATH ?= $(shell go env GOPATH)
BIN_PATH := $(GOPATH)/bin

.PHONY: grpc-gen grpc-clean grpc-rebuild


grpc-gen: check-plugins
	@echo "üîß Generating gRPC code..."
	@mkdir -p $(APP_PROTO_GEN)
	PATH="$(BIN_PATH):$$PATH" \
	protoc -I=$(APP_PROTO) -I=$(APP_PROTO_VALIDATE) \
		--go_out=$(APP_PROTO_GEN) --go_opt=paths=source_relative \
		--go-grpc_out=$(APP_PROTO_GEN) --go-grpc_opt=paths=source_relative \
		--validate_out=$(APP_PROTO_GEN) \
		--validate_opt=lang=go \
		--validate_opt=paths=source_relative \
		$(wildcard $(APP_PROTO)/*.proto)


grpc-clean:
	@echo "üßπ Cleaning generated gRPC files..."
	rm -rf $(APP_PROTO_GEN)
	@echo "‚úÖ Clean complete"


grpc-rebuild: grpc-clean grpc-gen


check-plugins:
	@echo "üì¶ Checking plugins in $(BIN_PATH)..."

	@if [ ! -x "$(BIN_PATH)/protoc-gen-go" ]; then \
		echo "‚¨áÔ∏è  Installing protoc-gen-go..."; \
		go install google.golang.org/protobuf/cmd/protoc-gen-go@latest; \
	else \
		echo "‚úÖ protoc-gen-go found."; \
	fi

	@if [ ! -x "$(BIN_PATH)/protoc-gen-go-grpc" ]; then \
		echo "‚¨áÔ∏è  Installing protoc-gen-go-grpc..."; \
		go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest; \
	else \
		echo "‚úÖ protoc-gen-go-grpc found."; \
	fi

	@if [ ! -x "$(BIN_PATH)/protoc-gen-validate" ]; then \
		echo "‚¨áÔ∏è  Installing protoc-gen-validate..."; \
		go get github.com/envoyproxy/protoc-gen-validate@latest; \
	else \
		echo "‚úÖ protoc-gen-validate found."; \
	fi

	@if ! echo $$PATH | grep -q "$(BIN_PATH)"; then \
		echo "‚ö†Ô∏è  $(BIN_PATH) is not in your PATH"; \
		echo "üëâ Please add this to your shell config (e.g. ~/.bashrc):"; \
		echo "   export PATH=\"\$$PATH:$(BIN_PATH)\""; \
	fi